<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PID vs LADRC Real-Time Simulator</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }
        canvas {
            background: #1f2937;
        }
    </style>
</head>
<body class="bg-gray-900 text-white">
    <div id="root" class="flex flex-col lg:flex-row w-full min-h-screen">
        <!-- Control Panel -->
        <div class="w-full lg:w-80 bg-gray-800 p-4 overflow-y-auto border-b lg:border-b-0 lg:border-r border-gray-700">
            <h1 class="text-2xl font-bold mb-4 text-blue-400">PID vs LADRC</h1>
            
            <div class="mb-6 space-y-2">
                <div class="flex gap-2">
                    <button id="playBtn" class="flex-1 bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded transition-colors">
                        ▶ Play
                    </button>
                    <button id="resetBtn" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded transition-colors">
                        ↻ Reset
                    </button>
                </div>
                <div id="timeDisplay" class="text-center text-sm text-gray-400">
                    Time: 0.00s / 10.0s
                </div>
            </div>

            <div class="mb-6">
                <label class="block text-sm font-medium mb-1">Speed: <span id="speedVal">1.0</span>x</label>
                <input type="range" id="speed" min="0.1" max="5" step="0.1" value="1.0" class="w-full">
            </div>

            <div class="mb-4">
                <h2 class="text-lg font-semibold mb-2 text-green-400">Plant Parameters</h2>
                <div class="space-y-2 text-sm">
                    <div>
                        <label class="block">ωₙ: <span id="wnVal">1.00</span></label>
                        <input type="range" id="wn" min="0.5" max="3" step="0.1" value="1.0" class="w-full">
                    </div>
                    <div>
                        <label class="block">ζ: <span id="zetaVal">0.20</span></label>
                        <input type="range" id="zeta" min="0.1" max="1" step="0.05" value="0.2" class="w-full">
                    </div>
                </div>
            </div>

            <div class="mb-4">
                <h2 class="text-lg font-semibold mb-2 text-yellow-400">PID Gains</h2>
                <div class="space-y-2 text-sm">
                    <div>
                        <label class="block">Kp: <span id="KpVal">8.0</span></label>
                        <input type="range" id="Kp" min="0" max="20" step="0.5" value="8.0" class="w-full">
                    </div>
                    <div>
                        <label class="block">Ki: <span id="KiVal">1.5</span></label>
                        <input type="range" id="Ki" min="0" max="5" step="0.1" value="1.5" class="w-full">
                    </div>
                    <div>
                        <label class="block">Kd: <span id="KdVal">3.0</span></label>
                        <input type="range" id="Kd" min="0" max="10" step="0.5" value="3.0" class="w-full">
                    </div>
                </div>
            </div>

            <div class="mb-4">
                <h2 class="text-lg font-semibold mb-2 text-purple-400">LADRC Bandwidths</h2>
                <div class="space-y-2 text-sm">
                    <div>
                        <label class="block">ωc: <span id="wcVal">2.0</span></label>
                        <input type="range" id="wc" min="0.5" max="10" step="0.5" value="2.0" class="w-full">
                    </div>
                    <div>
                        <label class="block">ω₀: <span id="woVal">30.0</span></label>
                        <input type="range" id="wo" min="5" max="50" step="1" value="30.0" class="w-full">
                    </div>
                </div>
            </div>

            <div class="mb-4">
                <h2 class="text-lg font-semibold mb-2 text-red-400">Disturbance</h2>
                <div class="space-y-2 text-sm">
                    <div>
                        <label class="block">Magnitude: <span id="distMagVal">2.0</span></label>
                        <input type="range" id="distMag" min="0" max="5" step="0.5" value="2.0" class="w-full">
                    </div>
                    <div>
                        <label class="block">Time: <span id="distTimeVal">2.0</span>s</label>
                        <input type="range" id="distTime" min="0" max="8" step="0.5" value="2.0" class="w-full">
                    </div>
                </div>
            </div>
        </div>

        <!-- Plots Panel -->
        <div class="flex-1 p-4 overflow-y-auto space-y-4">
            <div class="bg-gray-800 p-4 rounded-lg">
                <h3 class="text-lg font-semibold mb-2">Step Response</h3>
                <canvas id="stepChart" width="800" height="300"></canvas>
            </div>

            <div class="bg-gray-800 p-4 rounded-lg">
                <h3 class="text-lg font-semibold mb-2">Control Effort</h3>
                <canvas id="controlChart" width="800" height="300"></canvas>
            </div>

            <div class="bg-gray-800 p-4 rounded-lg">
                <h3 class="text-lg font-semibold mb-2">Disturbance Estimation</h3>
                <canvas id="distChart" width="800" height="300"></canvas>
            </div>
        </div>
    </div>

    <script>
        // Simulation state
        let isRunning = false;
        let simTime = 0;
        const dt = 0.001;
        const Tend = 10.0;
        
        let pidState = [0, 0];
        let ladrcState = [0, 0];
        let xhat = [0, 0, 0];
        let pidIntegral = 0;
        let pidePrev = 0;
        let pideDotFilt = 0;
        
        let params = {
            wn: 1.0,
            zeta: 0.2,
            b: 1.0,
            Kp: 8.0,
            Ki: 1.5,
            Kd: 3.0,
            tau_d: 0.05,
            wc: 2.0,
            wo: 30.0,
            b0: 1.0,
            distMag: 2.0,
            distTime: 2.0,
            speed: 1.0
        };

        let chartData = {
            t: [],
            ref: [],
            yPid: [],
            yLadrc: [],
            uPid: [],
            uLadrc: [],
            d: [],
            x3: []
        };

        // Canvas setup
        const stepCanvas = document.getElementById('stepChart');
        const controlCanvas = document.getElementById('controlChart');
        const distCanvas = document.getElementById('distChart');
        const stepCtx = stepCanvas.getContext('2d');
        const controlCtx = controlCanvas.getContext('2d');
        const distCtx = distCanvas.getContext('2d');

        function disturbance(t) {
            return t >= params.distTime ? params.distMag : 0.0;
        }

        function plantDerivatives(state, u, t) {
            const a1 = -(params.wn ** 2);
            const a2 = -2.0 * params.zeta * params.wn;
            const y = state[0];
            const yDot = state[1];
            const d = disturbance(t);
            const yDdot = a1 * y + a2 * yDot + params.b * u + d;
            return [yDot, yDdot];
        }

        function rk4Step(f, state, u, t, dt) {
            const k1 = f(state, u, t);
            const k2 = f([state[0] + 0.5 * dt * k1[0], state[1] + 0.5 * dt * k1[1]], u, t + 0.5 * dt);
            const k3 = f([state[0] + 0.5 * dt * k2[0], state[1] + 0.5 * dt * k2[1]], u, t + 0.5 * dt);
            const k4 = f([state[0] + dt * k3[0], state[1] + dt * k3[1]], u, t + dt);
            
            return [
                state[0] + (dt / 6.0) * (k1[0] + 2 * k2[0] + 2 * k3[0] + k4[0]),
                state[1] + (dt / 6.0) * (k1[1] + 2 * k2[1] + 2 * k3[1] + k4[1])
            ];
        }

        function pidControl(e, eDotFilt, eInt) {
            return params.Kp * e + params.Ki * eInt + params.Kd * eDotFilt;
        }

        function lesoDerivatives(xHat, yMeas, u) {
            const a1 = -(params.wn ** 2);
            const a2 = -2.0 * params.zeta * params.wn;
            const beta1 = 3.0 * params.wo;
            const beta2 = 3.0 * (params.wo ** 2);
            const beta3 = params.wo ** 3;
            
            const x1 = xHat[0], x2 = xHat[1], x3 = xHat[2];
            const e = yMeas - x1;
            
            return [
                x2 + beta1 * e,
                a1 * x1 + a2 * x2 + params.b0 * u + x3 + beta2 * e,
                beta3 * e
            ];
        }

        function ladrcControl(xHat, r, rDot, rDdot) {
            const a1 = -(params.wn ** 2);
            const a2 = -2.0 * params.zeta * params.wn;
            const kp = params.wc ** 2;
            const kd = 2.0 * params.wc;
            const x1 = xHat[0], x2 = xHat[1], x3 = xHat[2];
            
            const v = rDdot - kp * (x1 - r) - kd * (x2 - rDot);
            return (v - a1 * x1 - a2 * x2 - x3) / params.b0;
        }

        function simulationStep() {
            const r = 1.0, rDot = 0.0, rDdot = 0.0;

            // PID
            const yPid = pidState[0];
            const ePid = r - yPid;
            
            pidIntegral += ePid * dt;
            pidIntegral = Math.max(-5.0, Math.min(5.0, pidIntegral));
            
            const eDotRaw = (ePid - pidePrev) / dt;
            const alpha = params.tau_d / (params.tau_d + dt);
            pideDotFilt = alpha * pideDotFilt + (1 - alpha) * eDotRaw;
            pidePrev = ePid;
            
            const uPid = pidControl(ePid, pideDotFilt, pidIntegral);
            pidState = rk4Step(plantDerivatives, pidState, uPid, simTime, dt);

            // LADRC
            const yLadrc = ladrcState[0];
            const uLadrc = ladrcControl(xhat, r, rDot, rDdot);
            
            const dxhat = lesoDerivatives(xhat, yLadrc, uLadrc);
            xhat = [
                xhat[0] + dxhat[0] * dt,
                xhat[1] + dxhat[1] * dt,
                xhat[2] + dxhat[2] * dt
            ];
            
            ladrcState = rk4Step(plantDerivatives, ladrcState, uLadrc, simTime, dt);

            // Store data
            if (chartData.t.length === 0 || simTime - chartData.t[chartData.t.length - 1] >= 0.01) {
                chartData.t.push(simTime);
                chartData.ref.push(r);
                chartData.yPid.push(yPid);
                chartData.yLadrc.push(yLadrc);
                chartData.uPid.push(uPid);
                chartData.uLadrc.push(uLadrc);
                chartData.d.push(disturbance(simTime));
                chartData.x3.push(xhat[2]);

                if (chartData.t.length > 1000) {
                    Object.keys(chartData).forEach(key => chartData[key].shift());
                }
            }

            simTime += dt;
        }

        function drawChart(ctx, canvas, datasets, yLabel) {
            const width = canvas.width;
            const height = canvas.height;
            const padding = { left: 60, right: 20, top: 20, bottom: 50 };
            const plotWidth = width - padding.left - padding.right;
            const plotHeight = height - padding.top - padding.bottom;

            ctx.clearRect(0, 0, width, height);
            ctx.fillStyle = '#1f2937';
            ctx.fillRect(0, 0, width, height);

            if (chartData.t.length < 2) return;

            const xMin = 0;
            const xMax = Tend;
            let yMin = Infinity, yMax = -Infinity;

            datasets.forEach(dataset => {
                dataset.data.forEach(val => {
                    if (val < yMin) yMin = val;
                    if (val > yMax) yMax = val;
                });
            });

            const yRange = yMax - yMin;
            yMin -= yRange * 0.1;
            yMax += yRange * 0.1;

            // Grid
            ctx.strokeStyle = '#374151';
            ctx.lineWidth = 1;
            for (let i = 0; i <= 5; i++) {
                const y = padding.top + (plotHeight * i) / 5;
                ctx.beginPath();
                ctx.moveTo(padding.left, y);
                ctx.lineTo(padding.left + plotWidth, y);
                ctx.stroke();
            }

            // Axes
            ctx.strokeStyle = '#9ca3af';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(padding.left, padding.top);
            ctx.lineTo(padding.left, padding.top + plotHeight);
            ctx.lineTo(padding.left + plotWidth, padding.top + plotHeight);
            ctx.stroke();

            // Labels
            ctx.fillStyle = '#9ca3af';
            ctx.font = '12px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('Time [s]', padding.left + plotWidth / 2, height - 10);
            
            ctx.save();
            ctx.translate(15, padding.top + plotHeight / 2);
            ctx.rotate(-Math.PI / 2);
            ctx.fillText(yLabel, 0, 0);
            ctx.restore();

            // Plot data
            datasets.forEach(dataset => {
                ctx.strokeStyle = dataset.color;
                ctx.lineWidth = dataset.width || 2;
                if (dataset.dash) ctx.setLineDash(dataset.dash);
                else ctx.setLineDash([]);

                ctx.beginPath();
                for (let i = 0; i < chartData.t.length; i++) {
                    const x = padding.left + ((chartData.t[i] - xMin) / (xMax - xMin)) * plotWidth;
                    const y = padding.top + plotHeight - ((dataset.data[i] - yMin) / (yMax - yMin)) * plotHeight;
                    
                    if (i === 0) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);
                }
                ctx.stroke();
            });

            // Legend
            ctx.setLineDash([]);
            const legendX = width - 150;
            let legendY = padding.top + 20;
            datasets.forEach(dataset => {
                ctx.strokeStyle = dataset.color;
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.moveTo(legendX, legendY);
                ctx.lineTo(legendX + 30, legendY);
                ctx.stroke();
                
                ctx.fillStyle = '#fff';
                ctx.font = '12px sans-serif';
                ctx.textAlign = 'left';
                ctx.fillText(dataset.name, legendX + 35, legendY + 4);
                legendY += 20;
            });
        }

        function updateCharts() {
            drawChart(stepCtx, stepCanvas, [
                { name: 'Reference', data: chartData.ref, color: '#6b7280', dash: [5, 5] },
                { name: 'PID', data: chartData.yPid, color: '#fbbf24' },
                { name: 'LADRC', data: chartData.yLadrc, color: '#a78bfa' }
            ], 'Output');

            drawChart(controlCtx, controlCanvas, [
                { name: 'u_PID', data: chartData.uPid, color: '#fbbf24' },
                { name: 'u_LADRC', data: chartData.uLadrc, color: '#a78bfa' }
            ], 'Control');

            drawChart(distCtx, distCanvas, [
                { name: 'True d(t)', data: chartData.d, color: '#ef4444' },
                { name: 'LESO x₃', data: chartData.x3, color: '#10b981' }
            ], 'Disturbance');
        }

        let lastTime = 0;
        function animate(timestamp) {
            if (!isRunning) return;

            const elapsed = timestamp - lastTime;
            if (elapsed >= 16) {
                if (simTime >= Tend) {
                    isRunning = false;
                    document.getElementById('playBtn').textContent = '▶ Play';
                    return;
                }

                const stepsPerFrame = Math.ceil(16 * params.speed);
                for (let i = 0; i < stepsPerFrame && simTime < Tend; i++) {
                    simulationStep();
                }

                updateCharts();
                document.getElementById('timeDisplay').textContent = `Time: ${simTime.toFixed(2)}s / ${Tend}s`;
                lastTime = timestamp;
            }

            requestAnimationFrame(animate);
        }

        // Event listeners
        document.getElementById('playBtn').addEventListener('click', () => {
            isRunning = !isRunning;
            document.getElementById('playBtn').textContent = isRunning ? '⏸ Pause' : '▶ Play';
            if (isRunning) {
                lastTime = performance.now();
                requestAnimationFrame(animate);
            }
        });

        document.getElementById('resetBtn').addEventListener('click', () => {
            isRunning = false;
            simTime = 0;
            pidState = [0, 0];
            ladrcState = [0, 0];
            xhat = [0, 0, 0];
            pidIntegral = 0;
            pidePrev = 0;
            pideDotFilt = 0;
            chartData = { t: [], ref: [], yPid: [], yLadrc: [], uPid: [], uLadrc: [], d: [], x3: [] };
            updateCharts();
            document.getElementById('timeDisplay').textContent = 'Time: 0.00s / 10.0s';
            document.getElementById('playBtn').textContent = '▶ Play';
        });

        // Sliders
        const sliders = [
            {id: 'speed', val: 'speedVal'},
            {id: 'wn', val: 'wnVal'},
            {id: 'zeta', val: 'zetaVal'},
            {id: 'Kp', val: 'KpVal'},
            {id: 'Ki', val: 'KiVal'},
            {id: 'Kd', val: 'KdVal'},
            {id: 'wc', val: 'wcVal'},
            {id: 'wo', val: 'woVal'},
            {id: 'distMag', val: 'distMagVal'},
            {id: 'distTime', val: 'distTimeVal'}
        ];

        sliders.forEach(slider => {
            const elem = document.getElementById(slider.id);
            const display = document.getElementById(slider.val);
            elem.addEventListener('input', (e) => {
                const value = parseFloat(e.target.value);
                params[slider.id] = value;
                display.textContent = value.toFixed(slider.id === 'zeta' ? 2 : 1);
            });
        });

        // Initial draw
        updateCharts();
    </script>
</body>
</html>